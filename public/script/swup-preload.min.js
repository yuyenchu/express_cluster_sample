!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e||self).SwupPreloadPlugin=t()}(this,function(){const e=e=>String(e).split(".").concat(["0","0"]).slice(0,3).join(".");class t{constructor(){this.isSwupPlugin=!0,this.requires={},this.swup=void 0,this.version=void 0}mount(){}unmount(){}_beforeMount(){if(!this.name)throw new Error("You must define a name of plugin when creating a class.")}_afterUnmount(){}_checkRequirements(){return"object"!=typeof this.requires||Object.entries(this.requires).forEach(([t,r])=>{if(!function(t,r,s){const o=function(e,t){var r;if("swup"===e)return null!=(r=t.version)?r:"";{var s;const r=t.findPlugin(e);return null!=(s=null==r?void 0:r.version)?s:""}}(t,s);return!!o&&((t,r)=>r.every(r=>{const[,s,o]=r.match(/^([\D]+)?(.*)$/)||[];var n,i;return((e,t)=>{const r={"":e=>0===e,">":e=>e>0,">=":e=>e>=0,"<":e=>e<0,"<=":e=>e<=0};return(r[t]||r[""])(e)})((i=o,n=e(n=t),i=e(i),n.localeCompare(i,void 0,{numeric:!0})),s||">=")}))(o,r)}(t,r=Array.isArray(r)?r:[r],this.swup)){const e=`${t} ${r.join(", ")}`;throw new Error(`Plugin version mismatch: ${this.name} requires ${e}`)}}),!0}}function r(){return r=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},r.apply(this,arguments)}const s=({hash:e}={})=>location.pathname+location.search+(e?location.hash:"");class o extends URL{constructor(e,t=document.baseURI){super(e.toString(),t)}get url(){return this.pathname+this.search}static fromElement(e){const t=e.getAttribute("href")||e.getAttribute("xlink:href");return new o(t)}static fromUrl(e){return new o(e)}}return class extends t{constructor(e){void 0===e&&(e={}),super(),this.name="PreloadPlugin",this.requires={swup:">=3.0.0"},this.preloadPromises=new Map,this.defaults={throttle:5},this.onContentReplaced=()=>{this.swup.preloadPages()},this.onMouseEnter=e=>{e.target===e.delegateTarget&&this.deviceSupportsHover()&&(this.swup.triggerEvent("hoverLink",e),this.preloadLink(e.delegateTarget))},this.onTouchStart=e=>{this.deviceSupportsHover()||this.preloadLink(e.delegateTarget)},this.preloadPage=e=>{const t=this.swup,{url:s}=o.fromUrl(e);return new Promise((e,o)=>{t.cache.exists(s)?e(t.cache.getPage(s)):((n,i)=>{const a={url:window.location.pathname+window.location.search,method:"GET",data:null,headers:{}},{url:l,method:h,headers:u,data:d}=r({},a,n),c=new XMLHttpRequest;c.onreadystatechange=function(){4===c.readyState&&(r=>{if(500===r.status)return t.triggerEvent("serverError"),void o(s);const n=t.getPageData(r);if(!n||!n.blocks.length)return void o(s);const i={...n,url:s};t.cache.cacheUrl(i),t.triggerEvent("pagePreloaded",i),e(i)})(c)},c.open(h,l,!0),Object.entries(u).forEach(([e,t])=>{c.setRequestHeader(e,t)}),c.send(d)})({url:s,headers:t.options.requestHeaders})})},this.preloadPages=()=>{((e,t=document)=>Array.from(t.querySelectorAll("[data-swup-preload], [data-swup-preload-all] a")))().forEach(e=>{this.shouldIgnoreVisit(e.href,{el:e})||this.swup.preloadPage(e.href)})},this.options={...this.defaults,...e}}mount(){const e=this.swup;e.options.cache?(e._handlers.pagePreloaded=[],e._handlers.hoverLink=[],e.preloadPage=this.preloadPage,e.preloadPages=this.preloadPages,this.originalSwupFetchPage=e.fetchPage.bind(e),e.fetchPage=this.fetchPreloadedPage.bind(this),e.delegatedListeners.mouseenter=e.delegateEvent(e.options.linkSelector,"mouseenter",this.onMouseEnter.bind(this),{capture:!0}),e.delegatedListeners.touchstart=e.delegateEvent(e.options.linkSelector,"touchstart",this.onTouchStart.bind(this),{capture:!0}),e.preloadPages(),e.on("contentReplaced",this.onContentReplaced),e.preloadPage(s())):console.warn("PreloadPlugin: swup cache needs to be enabled for preloading")}unmount(){const e=this.swup;e.options.cache&&(this.preloadPromises=null,e._handlers.pagePreloaded=null,e._handlers.hoverLink=null,e.preloadPage=null,e.preloadPages=null,this.originalSwupFetchPage&&(e.fetchPage=this.originalSwupFetchPage,this.originalSwupFetchPage=null),e.delegatedListeners.mouseenter.destroy(),e.delegatedListeners.touchstart.destroy(),e.off("contentReplaced",this.onContentReplaced))}shouldIgnoreVisit(e,t){let{el:r}=void 0===t?{}:t;return this.swup.shouldIgnoreVisit(e,{el:r})}deviceSupportsHover(){return window.matchMedia("(hover: hover)").matches}preloadLink(e){const t=this.swup,{url:r}=o.fromElement(e);if(this.shouldIgnoreVisit(e.href,{el:e}))return;if(r===s())return;if(t.cache.exists(r))return;if(this.preloadPromises.has(r))return;if(this.preloadPromises.size>=this.options.throttle)return;const n=this.preloadPage(r);n.url=r,n.catch(()=>{}).finally(()=>{this.preloadPromises.delete(r)}),this.preloadPromises.set(r,n)}fetchPreloadedPage(e){const{url:t}=e,r=this.preloadPromises.get(t);return null!=r?r:this.originalSwupFetchPage(e)}}});
//# sourceMappingURL=index.umd.js.map
